<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼¢å­—ãƒ‰ãƒªãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background-color: #f0f4f8;
            color: #334155;
        }
        
        .print-page {
            width: 210mm;
            height: 297mm;
            padding: 12mm 15mm;
            margin: 20px auto;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .print-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #94a3b8;
        }
        .header-date { width: 35%; font-size: 16px; font-weight: bold; color: #475569; }
        .header-name { width: 45%; font-size: 16px; text-align: right; font-weight: bold; color: #475569; }
        .underline-box {
            display: inline-block;
            border-bottom: 2px solid #94a3b8;
            min-width: 40px;
            text-align: center;
        }

        .question-grid {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: repeat(10, 1fr);
            gap: 4px;
            flex-grow: 1;
        }

        .question-box {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            height: 100%;
            box-sizing: border-box;
            position: relative;
        }

        .img-preview-box {
            width: 85px;
            height: 70px;
            background-color: #f8fafc;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .img-preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .sentence-display {
            font-size: 1.8rem;
            line-height: 1.6;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            flex-grow: 1;
            color: #1e293b;
        }

        .q-underline {
            border-bottom: 3px solid #334155;
            padding: 0 8px;
            margin: 0 6px;
            position: relative;
            font-weight: bold;
            min-width: 4rem;
            text-align: center;
            display: inline-block;
        }

        .q-ruby {
            position: absolute;
            top: -1.0rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            white-space: nowrap;
            font-weight: bold;
            color: #475569;
        }

        .ans-area {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 160px;
        }

        .ans-line {
            width: 160px;
            border-bottom: 3px solid #64748b;
            height: 50px;
        }

        @media print {
            @page { size: A4; margin: 0; }
            .no-print { display: none !important; }
            body { background: white; margin: 0; padding: 0; }
            .print-page { 
                margin: 0; 
                border: none;
                border-radius: 0; 
                box-shadow: none; 
                page-break-after: always;
                height: 100vh;
                width: 100vw;
            }
        }

        details summary {
            cursor: pointer;
            list-style: none;
            outline: none;
        }
        details[open] summary span.arrow {
            transform: rotate(180deg);
        }

        .reorder-btn { display: flex; flex-direction: column; gap: 2px; }
        .reorder-btn button {
            padding: 2px 6px;
            background: #f1f5f9;
            border-radius: 4px;
            font-size: 10px;
            color: #94a3b8;
        }

        /* ãƒ˜ãƒ«ãƒ—å¹ãå‡ºã—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #help-popover {
            position: fixed;
            bottom: 85px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: none;
            z-index: 100;
            border: 1px solid #e2e8f0;
        }
        #help-popover::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 25px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: white transparent transparent;
        }
    </style>
</head>
<body class="pb-20">

    <div class="no-print max-w-5xl mx-auto p-6">
        <header class="mb-8 text-center md:text-left flex justify-between items-center">
            <h1 class="text-3xl font-bold text-slate-700">ğŸ“ æ¼¢å­—ãƒ‰ãƒªãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 mb-6 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                <div class="space-y-2 lg:col-span-2">
                    <label class="block text-sm font-bold text-slate-600">â‘  Excel/CSV èª­ã¿è¾¼ã¿</label>
                    <input type="file" id="excel-file" accept=".xlsx, .xls, .csv" 
                           class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 cursor-pointer"/>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-bold text-slate-600">â‘¡ å•é¡Œæ•°</label>
                    <input type="number" id="question-count" value="10" min="1" max="100" 
                           class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-sky-500 font-bold text-slate-700">
                </div>
                <button onclick="importExcel()" class="bg-sky-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:bg-sky-700 transition">
                    èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å•é¡Œã‚’ç”Ÿæˆ
                </button>
            </div>
            
            <div class="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-slate-100">
                <div class="flex flex-wrap gap-4">
                    <div class="flex bg-slate-200 p-1 rounded-xl">
                        <button onclick="setMode('read')" id="btn-read" class="px-6 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-sky-600">èª­ã¿ã¨ã‚Š</button>
                        <button onclick="setMode('write')" id="btn-write" class="px-6 py-2 rounded-lg text-sm font-bold text-slate-500">æ›¸ãã¨ã‚Š</button>
                    </div>
                    <button onclick="shuffleQuestions()" class="bg-amber-100 text-amber-700 px-6 py-2 rounded-xl text-sm font-bold border border-amber-200 hover:bg-amber-200 transition flex items-center gap-2">
                        <span>ğŸ”€</span> å•é¡Œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    </button>
                    <label class="bg-indigo-100 text-indigo-700 px-6 py-2 rounded-xl text-sm font-bold border border-indigo-200 hover:bg-indigo-200 transition flex items-center gap-2 cursor-pointer">
                        <span>ğŸ–¼ï¸</span> ç”»åƒã‚’ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        <input type="file" id="bulk-images" accept="image/*" multiple onchange="handleBulkImages(this)" class="hidden">
                    </label>
                </div>
                
                <button onclick="window.print()" class="bg-emerald-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-600 transition flex items-center gap-2">
                    <span>ğŸ–¨ï¸</span> å°åˆ·ã™ã‚‹
                </button>
            </div>
        </div>

        <div class="space-y-3 mb-8">
            <details class="bg-slate-50 border border-slate-200 rounded-2xl group overflow-hidden">
                <summary class="p-4 font-bold text-slate-600 text-sm flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="bg-sky-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px]">1</span>
                        Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œã‚Šæ–¹ã‚’ç¢ºèªã™ã‚‹
                    </div>
                    <span class="arrow transition-transform duration-300 text-slate-400">â–¼</span>
                </summary>
                <div class="p-5 pt-0 border-t border-slate-200/50">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs mt-4">
                        <div class="bg-white p-3 rounded-lg border border-slate-200">
                            <p class="font-bold text-sky-600 mb-1">Aåˆ—ï¼šæ¼¢å­—ï¼ˆå˜èªï¼‰</p>
                            <p class="text-slate-500">å•é¡Œã«ã—ãŸã„æ¼¢å­—ã‚’å…¥åŠ›ã—ã¾ã™ã€‚</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-slate-200">
                            <p class="font-bold text-sky-600 mb-1">Båˆ—ï¼šæ–‡ç« </p>
                            <p class="text-slate-500">Aåˆ—ã®æ¼¢å­—ã‚’å«ã‚ãŸæ–‡ç« ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>ä¾‹ï¼šAåˆ—ã«[å±±]ãªã‚‰ã€Œå±±ã«ã®ã¼ã‚‹ã€ã€‚<br><span class="text-[10px] font-bold">â€»Aåˆ—ã®æ¼¢å­—ãŒè‡ªå‹•ã§å•é¡Œã«ãªã‚Šã¾ã™ã€‚</span></p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-slate-200">
                            <p class="font-bold text-sky-600 mb-1">Cåˆ—ï¼šãµã‚ŠãŒãª</p>
                            <p class="text-slate-500">ã€Œæ›¸ãã¨ã‚Šã€ã§ä½¿ç”¨ã™ã‚‹ãµã‚ŠãŒãªã§ã™ã€‚</p>
                        </div>
                    </div>
                </div>
            </details>

            <details class="bg-slate-50 border border-slate-200 rounded-2xl group overflow-hidden">
                <summary class="p-4 font-bold text-slate-600 text-sm flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="bg-emerald-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px]">2</span>
                        æ‰‹å‹•ã§å•é¡Œã‚’ä½œæˆã™ã‚‹ï¼ˆç·¨é›†ã™ã‚‹ï¼‰æ–¹æ³•
                    </div>
                    <span class="arrow transition-transform duration-300 text-slate-400">â–¼</span>
                </summary>
                <div class="p-5 pt-0 border-t border-slate-200/50">
                    <div class="text-xs space-y-3 mt-4 text-slate-600">
                        <div class="flex items-start gap-2">
                            <span class="font-bold text-emerald-600 min-width-[4em]">æ‰‹é †:</span>
                            <p>å•é¡Œã«ã—ãŸã„éƒ¨åˆ†ã‚’ <span class="bg-amber-100 text-amber-700 px-1 rounded font-bold text-[13px]">[ ]</span> ã§å›²ã¿ã¾ã™ã€‚ä¾‹ï¼š[é’ã„]ç©ºãŒè¦‹ãˆã‚‹</p>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <div id="input-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"></div>
        <button onclick="addQuestion()" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:bg-slate-50 transition">ï¼‹ æ–°ã—ã„å•é¡Œã‚’è¿½åŠ </button>
    </div>

    <div class="fixed bottom-6 right-6 no-print flex flex-col items-end">
        <div id="help-popover" class="p-5">
            <h3 class="font-bold text-slate-700 mb-3 border-bottom pb-2 flex items-center gap-2">
                ğŸš€ ã¤ã‹ã„ã‹ãŸã‚¬ã‚¤ãƒ‰
            </h3>
            <div class="text-xs space-y-4 text-slate-600 leading-relaxed">
                <div>
                    <p class="font-bold text-sky-600">1. å•é¡Œã‚’ç”¨æ„ã™ã‚‹</p>
                    <p>Excelã‚’èª­ã¿è¾¼ã‚€ã‹ã€ã€Œæ–°ã—ã„å•é¡Œã‚’è¿½åŠ ã€ã§ç›´æ¥å…¥åŠ›ã—ã¾ã™ã€‚</p>
                </div>
                <div>
                    <p class="font-bold text-sky-600">2. ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã¶</p>
                    <p>æ¼¢å­—ã‚’è¦‹ã›ã‚‹ã€Œèª­ã¿ã¨ã‚Šã€ã€ãµã‚ŠãŒãªã‚’è¦‹ã›ã‚‹ã€Œæ›¸ãã¨ã‚Šã€ã‚’ãƒœã‚¿ãƒ³ã§åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</p>
                </div>
                <div>
                    <p class="font-bold text-sky-600">3. ç”»åƒã‚’ã„ã‚Œã‚‹</p>
                    <p>å•é¡Œã”ã¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã‹ã€ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å†™çœŸã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>
                </div>
                <div>
                    <p class="font-bold text-sky-600">4. å°åˆ·ã™ã‚‹</p>
                    <p>å³ä¸Šã®ã€Œå°åˆ·ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§A4ç”¨ç´™ã«ã´ã£ãŸã‚Šå‡ºåŠ›ã•ã‚Œã¾ã™ï¼</p>
                </div>
            </div>
            <button onclick="toggleHelp()" class="mt-4 w-full py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-bold transition">ã¨ã˜ã‚‹</button>
        </div>
        <button onclick="toggleHelp()" class="w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition-transform active:scale-95">
            ï¼Ÿ
        </button>
    </div>

    <div id="print-preview-container"></div>

    <script>
        let currentMode = 'read';
        let questions = [{ text: '', reading: '', img: '' }];

        function toggleHelp() {
            const popover = document.getElementById('help-popover');
            popover.style.display = popover.style.display === 'block' ? 'none' : 'block';
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-read').className = mode === 'read' ? 'px-6 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-sky-600' : 'px-6 py-2 rounded-lg text-sm font-bold text-slate-500';
            document.getElementById('btn-write').className = mode === 'write' ? 'px-6 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-sky-600' : 'px-6 py-2 rounded-lg text-sm font-bold text-slate-500';
            renderPreview();
        }

        function importExcel() {
            const fileInput = document.getElementById('excel-file');
            const countInput = document.getElementById('question-count');
            const count = parseInt(countInput.value) || 10;
            if (!fileInput.files[0]) { alert("Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                let allData = jsonData.filter(row => row.length >= 2).map(row => {
                    const kanji = String(row[0] || "");
                    let sentence = String(row[1] || "");
                    const reading = String(row[2] || "");
                    if (!sentence.includes('[') && kanji !== "" && sentence.includes(kanji)) {
                        sentence = sentence.replace(kanji, `[${kanji}]`);
                    }
                    return { text: sentence, reading: reading, img: '' };
                });
                questions = allData.slice(0, count);
                render();
            };
            reader.readAsArrayBuffer(file);
        }

        async function handleBulkImages(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            files.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
            for (let i = 0; i < files.length && i < questions.length; i++) {
                const reader = new FileReader();
                const promise = new Promise((resolve) => {
                    reader.onload = (e) => {
                        questions[i].img = e.target.result;
                        resolve();
                    };
                });
                reader.readAsDataURL(files[i]);
                await promise;
            }
            render();
            input.value = "";
        }

        function shuffleQuestions() {
            if (questions.length <= 1) return;
            for (let i = questions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [questions[i], questions[j]] = [questions[j], questions[i]];
            }
            render();
        }

        function addQuestion() {
            questions.push({ text: '', reading: '', img: '' });
            render();
        }

        function moveQuestion(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < questions.length) {
                [questions[index], questions[newIndex]] = [questions[newIndex], questions[index]];
                render();
            }
        }

        function updateData(index, key, value) {
            questions[index][key] = value;
            renderPreview();
        }

        function handleImage(index, input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    questions[index].img = e.target.result;
                    render();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderInputs() {
            const container = document.getElementById('input-container');
            container.innerHTML = '';
            questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold text-slate-400">å•é¡Œ ${i + 1}</span>
                            <div class="reorder-btn no-print">
                                <button onclick="moveQuestion(${i}, -1)" ${i === 0 ? 'disabled' : ''}>â–²</button>
                                <button onclick="moveQuestion(${i}, 1)" ${i === questions.length - 1 ? 'disabled' : ''}>â–¼</button>
                            </div>
                        </div>
                        <button onclick="questions.splice(${i},1); render();" class="text-slate-300 hover:text-rose-400 font-bold px-2">âœ•</button>
                    </div>
                    <div class="flex gap-3">
                        <label class="w-16 h-16 bg-slate-100 rounded-lg flex-shrink-0 cursor-pointer overflow-hidden border-2 border-dashed border-slate-200 flex items-center justify-center hover:bg-slate-200">
                            ${q.img ? `<img src="${q.img}" class="w-full h-full object-cover">` : '<span class="text-[10px] text-slate-400 font-bold">ç”»åƒ</span>'}
                            <input type="file" accept="image/*" onchange="handleImage(${i}, this)" class="hidden">
                        </label>
                        <div class="flex-grow space-y-2">
                            <input type="text" placeholder="æ–‡ç« ã‚’å…¥åŠ› â€»ä¾‹: [å±±]ã«ã®ã¼ã‚‹" oninput="updateData(${i}, 'text', this.value)" value="${q.text}" class="w-full p-1 border-b border-slate-200 outline-none text-sm font-bold text-slate-700 focus:border-sky-400">
                            <input type="text" placeholder="ãµã‚ŠãŒãªã‚’å…¥åŠ›" oninput="updateData(${i}, 'reading', this.value)" value="${q.reading}" class="w-full p-1 border-b border-slate-200 outline-none text-xs text-sky-600 focus:border-sky-400">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function parseSentence(text, reading) {
            const regex = /\[(.*?)\]/;
            const match = text.match(regex);
            if (!match) return `<span>${text}</span>`;
            const parts = text.split(regex);
            if (currentMode === 'write') {
                return `<span>${parts[0]}</span><span class="q-underline"><span class="q-ruby">${reading}</span>&nbsp;</span><span>${parts[2] || ''}</span>`;
            } else {
                return `<span>${parts[0]}</span><span class="q-underline">${match[1]}</span><span>${parts[2] || ''}</span>`;
            }
        }

        function renderPreview() {
            const container = document.getElementById('print-preview-container');
            container.innerHTML = '';
            for (let i = 0; i < questions.length; i += 10) {
                const chunk = questions.slice(i, i + 10);
                const page = document.createElement('div');
                page.className = 'print-page';
                page.innerHTML = `
                    <div class="print-header">
                        <div class="header-date"><span class="underline-box"></span> ãŒã¤ <span class="underline-box"></span> ã«ã¡</div>
                        <div class="header-name">ãªã¾ãˆ <span class="underline-box" style="min-width: 200px;"></span></div>
                    </div>
                    <div class="question-grid" id="grid-${i}"></div>
                `;
                container.appendChild(page);
                const grid = document.getElementById(`grid-${i}`);
                chunk.forEach((q, j) => {
                    const box = document.createElement('div');
                    box.className = 'question-box';
                    box.innerHTML = `
                        <div class="text-[12px] font-bold text-slate-400 w-6">${i + j + 1}</div>
                        <div class="img-preview-box">${q.img ? `<img src="${q.img}">` : ''}</div>
                        <div class="sentence-display">${parseSentence(q.text, q.reading)}</div>
                        <div class="ans-area"><div class="ans-line"></div></div>
                    `;
                    grid.appendChild(box);
                });
                for (let k = chunk.length; k < 10; k++) {
                    const empty = document.createElement('div');
                    empty.className = 'question-box border-dashed opacity-20';
                    empty.innerHTML = `
                        <div class="text-[12px] font-bold w-6">${i + k + 1}</div>
                        <div class="img-preview-box"></div>
                        <div class="sentence-display"></div>
                        <div class="ans-area"><div class="ans-line"></div></div>
                    `;
                    grid.appendChild(empty);
                }
            }
        }

        function render() { renderInputs(); renderPreview(); }
        render();
    </script>
</body>
</html>